using Microsoft.Data.SqlClient;
using MVCDemo.Models;
namespace MVCDemo.Models
{
    public class StudentViewModel
    {
        string connectionString = "Data Source=(LocalDB)\\MSSQLLocalDB;Initial Catalog=LabDB;Integrated Security=True;";
        public List<Student> GetStudents()
        {
            List<Student> students = new List<Student>();

            SqlConnection connection = 
                new SqlConnection(connectionString);
            connection.Open();

            SqlCommand command =
                new SqlCommand("select * from Student", connection);
            SqlDataReader reader = command.ExecuteReader();
            while(reader.Read()) { 
                Student student = new Student();
                student.No = Convert.ToInt32(reader["No"]);
                student.Name = reader["Name"].ToString();
                student.Address = reader["Address"].ToString();
                student.EMail = reader["EMail"].ToString();
                student.Age = Convert.ToInt32(reader["Age"]);
                students.Add(student);
            }
            connection.Close();

            return students;
        }
        public Student GetStudent(int No)
        {
            List<Student> students = GetStudents();
            Student filteredStudent = (from student in students
                                       where student.No == No
                                       select student).First();
            return filteredStudent;
        }
        public int AddStudent(Student student)
        {
            SqlConnection connection = 
                new SqlConnection(connectionString);
                
            connection.Open();

            string queryFormat = "insert into Student(Name, Address, Age, EMail, IsEMailValidated) values('{0}','{1}',{2},'{3}','{4}')";

            string query = string.Format(queryFormat,
                                            student.Name,
                                            student.Address,
                                            student.Age,
                                            student.EMail,
                                            false);
            SqlCommand command = new SqlCommand(query , connection);
            int rowsAffected = command.ExecuteNonQuery();
            connection.Close();
            return rowsAffected;    
        }

        public int AddStudentViaProcedure(Student student)
        {
            SqlConnection connection =
                new SqlConnection(connectionString);

            connection.Open();

            SqlCommand command = new SqlCommand("AddRecord", connection);
            command.CommandType = System.Data.CommandType.StoredProcedure;

            SqlParameter p1 = new SqlParameter();
            p1.ParameterName = "Name";
            p1.Value = student.Name;

            SqlParameter p2 = new SqlParameter();
            p2.ParameterName = "Address";
            p2.Value = student.Address;

            SqlParameter p3 = new SqlParameter();
            p3.ParameterName = "Age";
            p3.Value = student.Age;

            SqlParameter p4 = new SqlParameter();
            p4.ParameterName = "EMail";
            p4.Value = student.EMail;

            command.Parameters.Add(p1);
            command.Parameters.Add(p2);
            command.Parameters.Add(p3);
            command.Parameters.Add(p4);

            int rowsAffected = command.ExecuteNonQuery();
            connection.Close();
            return rowsAffected;
        }
        public int UpdateStudent(Student student)
        {
            SqlConnection connection =
                new SqlConnection(connectionString);

            connection.Open();

            string queryFormat = "update Student set Name = '{0}',Address = '{1}', Age = {2}, EMail= '{3}' where No = {4}";

            string query = string.Format(queryFormat,
                                            student.Name,
                                            student.Address,
                                            student.Age,
                                            student.EMail,
                                            student.No);

            SqlCommand command = new SqlCommand(query, connection);
            int rowsAffected = command.ExecuteNonQuery();
            connection.Close();
            return rowsAffected;
        }
        public int RemoveStudent(int No)
        {
            SqlConnection connection =
                new SqlConnection(connectionString);

            connection.Open();

            string queryFormat = "delete from Student where No = {0}";

            string query = string.Format(queryFormat,No);
            SqlCommand command = new SqlCommand(query, connection);
            int rowsAffected = command.ExecuteNonQuery();
            connection.Close();
            return rowsAffected;
        }
    }
}
